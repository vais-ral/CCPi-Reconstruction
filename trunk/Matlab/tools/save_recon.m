function [ outflag filebase ] = save_recon( )
%save_recon - choose how to the reconstructed data should be saved.
%   Choose the base filename for the reconstructed data and
%   what format the data should be saved in.

    filebase = 'cgls';
    % 1 - tiff uint16; 2 - tiff uint8, 3 - float dump
    outflag = 1;
    
    H = figure('Units', 'Normalized',...
               'Position', [0.1 0.1 0.5 0.5],...
               'Toolbar', 'None',...
               'Name', 'Save cgls reconstruction',...
               'WindowStyle', 'Modal');
       
    okgui = uicontrol('Parent', H,...
                  'Units', 'Normalized',...
                  'Position', [0.4 0.1 0.2 0.1],...
                  'Style', 'pushbutton',...
                  'String', 'OK',...
                  'Callback', @okfn );

    radiogui = uibuttongroup('Parent', H,...
                             'Units', 'Normalized',...
                             'Visible', 'off',...
                             'Position', [0.5 0.6 0.4 0.3]);
    button1 = uicontrol('Parent', radiogui,...
                        'Style', 'radiobutton',...
                        'HandleVisibility','off',...
                        'Units', 'Normalized',...
                        'Position', [0.05 0.75 0.9 0.2],...
                        'String', '16 bit Tiff');
    button2 = uicontrol('Parent', radiogui,...
                        'Style', 'radiobutton',...
                        'HandleVisibility','off',...
                        'Units', 'Normalized',...
                        'Position', [0.05 0.5 0.9 0.2],...
                        'String', '8 bit Tiff');
    button3 = uicontrol('Parent', radiogui,...
                        'Style', 'radiobutton',...
                        'HandleVisibility','off',...
                        'Units', 'Normalized',...
                        'Position', [0.05 0.25 0.9 0.2],...
                        'String', 'Raw float data');
    % Initialize some button group properties. 
    set(radiogui,'SelectionChangeFcn',@selfn);
    set(radiogui,'SelectedObject', [button1]);
    set(radiogui,'Visible','on');

    radiolabel = uicontrol('Parent', H,...
                           'Units', 'Normalized',...
                           'Position', [0.1 0.6 0.4 0.3],...
                           'Style', 'text',...
                           'String', 'File format');

    filegui = uicontrol('Parent', H,...
                        'Units', 'Normalized',...
                        'Position', [0.5 0.4 0.4 0.05],...
                        'Style', 'edit',...
                        'String', filebase,...
                        'Callback', @filefn );

    filelabel = uicontrol('Parent', H,...
                          'Units', 'Normalized',...
                          'Position', [0.1 0.4 0.4 0.05],...
                          'Style', 'text',...
                          'String', 'Initial part of save filename');

    uiwait(H);
               
    function okfn(cbo, eventdata)
        % callback for OK button
        ok = true;
        uiresume;
        delete(H);
    end

    function selfn(source, eventdata)
        % callback for radio button group
        newval = get(eventdata.NewValue, 'String');
        if strcmp(newval, '16 bit Tiff')
            outflag = 1;
        elseif strcmp(newval, '8 bit Tiff')
            outflag = 2;
        else
            outflag = 3;
        end
    end

    function filefn(cbo, eventdata)
        % callback for basename of file.
        filebase = get(cbo, 'String');
    end

end

